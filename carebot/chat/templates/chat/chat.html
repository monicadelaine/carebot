<!DOCTYPE html>
<html>
<head>
    <title>Chat with Carebot</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'chat/styles.css' %}">
    <meta name="csrf-token" content="{{ csrf_token }}">
</head>
<body>
    <div id="chatbot-container">
        <header>
            {% include "chat/header.html" %}
        </header>
        <div id="chat-messages">
            {% for message in chat_history %}
                {% if message.message_type == 0 %}
                <div class="user-message">
                    <p>{{ message.text }}</p>
                </div>
                {% endif %}
                {% if message.message_type == 1 %}
                <div class="ai-message">
                    <p>{{ message.text }}</p>
                </div>
                {% endif %}
                {% if message.message_type == 2 %}
                <div class="system-message">
                    <p>{{ message.text }}</p>
                </div>
                {% endif %}
            {% endfor %}
        </div>
        <div id="suggested-messages">
            <button id="suggested_1" type="button" class="btn-send suggested-message" value="Help me find counseling services in my area.">Help me find counseling services in my area.</button>
            <button id="suggested_2" type="button" class="btn-send suggested-message" value="Help me find food banks in my area.">Help me find food banks in my area.</button>
        </div>
        <form method="post" id="chat-form">
            {% csrf_token %}
            <div class="form-group">
                {{ form.query }}
                <label>
                   <!-- <input type="checkbox" name="is_sql" id="is_sql"> This is an SQL query -->
                </label>
                <button type="submit" class="btn-send">Send</button>
            </div>
        </form>
        <div id="loading" style="display: none;">
            <p><span class="dot"></span><span class="dot"></span><span class="dot"></span></p>
        </div>
    </div>
    <script src="{% static 'chat/chat.js' %}"></script>
    <script>
        function sendSuggestedMessage(button) {
            const text = button.value;
            const form = document.getElementById("chat-form");
            const input = form.querySelector("input[name='query']");
            input.value = text;
        }
        var suggested_1 = document.getElementById("suggested_1");
        suggested_1.addEventListener('click', function() {
            sendSuggestedMessage(suggested_1);
        });
        var suggested_2 = document.getElementById("suggested_2");
        suggested_2.addEventListener('click', function() {
            sendSuggestedMessage(suggested_2);
        });
        
        window.addEventListener('beforeunload', function (e) {
            const csrfToken = getCsrfToken();
            const data = new FormData();
            data.append('csrfmiddlewaretoken', csrfToken);

            // Asynchronously clear the session
            navigator.sendBeacon('/clear-session/', data);
            return  // Do not alert the user about leaving the page
        });
        const chat_box = document.getElementById("chat-form");
        chat_box.autocomplete = "off"
    </script>
</body>
</html>
