# Carebot Technical Documentation

**Scope:** This document covers the purpose and function of all of the files in this repository that were not automatically generated. This includes all Docker setup files, HTML pages, CSS, the .env file, and Python Django files. It does not include static files, the healthcare resource database, the Pipfile, Python caches, or files automatically generated by Django (like migrations).

```text
root
│   .dockerignore
│   .env
|   .gitattributes
|   .gitignore
|   CS 495 API Research.xlsx
|   database_dump.sql
|   docker-compose.yml
|   docker-entrypoint.sh
|   Dockerfile
|   FAQ.md
|   modify&extend_documentation.md
|   notes.txt
|   Pipfile (out of scope)
|   README.md
|   requirements.txt
|   technical_documentation.md
│
└───carebot
│   │   manage.py
│   │
│   └───carebot
│   │   │   __init__.py
│   │   │   asgi.py
│   │   │   settings.py
│   │   │   urls.py
│   │   │   wsgi.py
│   │
│   └───chat
│       │   __init__.py
│       │   admin.py
│       │   apps.py
│       │   forms.py
│       │   models.py
│       │   tests.py
│       │   urls.py
│       │   views.py
|       |
|       └───migrations (contents are out of scope)
|       |   |   ...
|       |
|       └───static
|       |   |
|       |   └───chat
|       |       |   caregiver_connect_icon.svg
|       |       |   chat.js
|       |       |   city-to-county.json
|       |       |   county_centroids.json
|       |       |   dashboard.js
|       |       |   home_icon.png
|       |       |   jake.jpg
|       |       |   kittson_short.jpg
|       |       |   owl_png.png
|       |       |   q.png
|       |       |   scott.jpg
|       |       |   server.js
|       |       |   styles.css
|       |       |   table.js
|       |
|       └───templates
|       |   |
|       |   └───chat
|       |       |   about-us.html
|       |       |   chat.html
|       |       |   dashboard.html
|       |       |   deliverables.html
|       |       |   documentation.html
|       |       |   error.html
|       |       |   faq.html
|       |       |   footer.html
|       |       |   header.html
|       |       |   home.html
```

# /

**Purpose:** This is the root of the repository.

## /.dockerignore

**Purpose:** This file tells Docker which files to ignore (i.e.: not to copy to the image). These are mostly machine-generated files like the Python cache.

## /.env

**Purpose:** This file contains the environment variables required to setup the Docker image and run Django. This file must be created manually. It is not included in the repository. This file should **never** be uploaded to any kind of repository for security purposes. Use environment variables and secrets according to best security practices.

| Variable Name | Type       | Value        | Other Notes |
| ------------- | ---------- | ------------ | ----------- |
| OPEN_API_KEY | string | (varies) | This value is provided when you pay OpenAI for an API key. |
| DEBUG | string | True *or* False | [Django documentation](https://docs.djangoproject.com/en/5.0/ref/settings/#debug) |
| INSECURE_FLAG | string | --insecure *or* blank | [Django documentation](https://docs.djangoproject.com/en/5.0/ref/contrib/staticfiles/#cmdoption-runserver-insecure) |
| SECRET_KEY | string | (varies) | [Django documentation](https://docs.djangoproject.com/en/5.0/ref/settings/#secret-key) |

## /.gitattributes

 This file is intended to force Git to use the Unix-style LF file ending for shell scripts, such as docker-entrypoint.

## /.gitignore

 See [Git documentation](https://git-scm.com/docs/gitignore).

## /database_dump.sql

 This is the database dump of healthcare resources that should be loaded when the Docker container is started.

## /docker-compose.yml

 This is the file used by the `docker compose` command when building or starting the container. This includes both the PostGIS and carebot containers. The file relies on the `INSECURE_FLAG` value in `.env`. See the [Docker documentation](https://docs.docker.com/compose/).

## /docker-entrypoint.sh

 See the [Docker documentation](https://docs.docker.com/reference/dockerfile/#entrypoint).

## /Dockerfile

 This is the file Docker uses to set up the image upon build. Ours includes Python, PostgreSQL, and Django, among others. See the [Docker documentation](https://docs.docker.com/reference/dockerfile/).

## /README.md

 This file provides basic setup instructions.

## /requirements.txt

 This file contains the Python dependencies the pipenv will automatically install upon Docker setup. See [pipenv documentation](https://pipenv.pypa.io/en/latest/pipfile.html#importing-from-requirements-txt).

## /technical_documentation.md

 This document covers the purpose and function of all of the files in this repository that were not automatically generated. This includes all Docker setup files, HTML pages, CSS, the .env file, and Python Django files. It does not include static files, the healthcare resource database, the Pipfile, or Python caches.

# /carebot/

 This folder contains the Django project, `carebot`.  It was automatically generated when the Django project was created.

## manage.py

 This file is used by Django to manage the application. See [Django documentation](https://docs.djangoproject.com/en/5.0/ref/django-admin/#django-admin-and-manage-py).

# /carebot/carebot/

 This folder contains files for Django project (not app) management. It was automatically generated when the Django project was created.

## /carebot/carebot/\_\_init\_\_.py

 This file was automatically generated when the Django project was created. It is empty, but it tells Python that the files in this directory should be treated as a package.

## /carebot/carebot/asgi.py

 See [Django documentation](https://docs.djangoproject.com/en/5.0/howto/deployment/asgi/).

## /carebot/carebot/settings.py

 This file contains settings for the Django project. It depends on many environment variables from `.env`. See [Django documentation](https://docs.djangoproject.com/en/5.0/ref/settings/).

## /carebot/carebot/urls.py

 This file contains the url patterns for the Django project. Most of the project's urls are accessed through the `chat` app. See [Django documentation](https://docs.djangoproject.com/en/5.0/topics/http/urls/).

## /carebot/carebot/wsgi.py

 See [Django documentation](https://docs.djangoproject.com/en/5.0/howto/deployment/wsgi/).

# /carebot/chat/

 This folder contains files for Django app `chat` (not project). It was automatically generated when the Django app was created. The `chat` app is the bulk of the Carebot project.

## /carebot/chat/\_\_init\_\_.py

 This file was automatically generated when the Django project was created. It is empty, but it tells Python that the files in this directory should be treated as a package.

## /carebot/chat/admin.py

 This file was automatically generated when the Django app was created. See [Django documentation](https://docs.djangoproject.com/en/5.0/ref/contrib/admin/actions/).

## /carebot/chat/apps.py

 This file was automatically generated when the Django app was created. See [Django documentation](https://docs.djangoproject.com/en/5.0/ref/applications/).

## /carebot/chat/forms.py

 This file contains the form(s) for the project. Currently, the only form is the QueryForm, which dictates the attributes of form used to send a user's chat messages. See See [Django documentation](https://docs.djangoproject.com/en/5.0/topics/http/urls/) for more on forms.

## /carebot/chat/models.py

 This file contains the models for the project. See [Django documentation](https://docs.djangoproject.com/en/5.0/topics/http/urls/) for more on models.

| Model Name | Purpose |
| ---------- | ------- |
| MessageType | MessageType is an IntEnum for the type of a message (user, chatbot, or system). User messages are sent by the user, chatbot messages are generated primarily by ChatGPT, and system messages are for communicating errors directly to the user. |
| Message | This model stores messages of all kinds. All bubbles that appear on the chat page are representations of a Message model. |
| ChatRequestGeoData | This model stores a user's location data anonymously. It is currently unused because the location feature cannot be implemented without HTTPS. |

## /carebot/chat/tests.py

**Purpose:** This file contains Django test cases for testing chat view functionalities, AJAX requests, session management, and database interactions within a chat application.See [Django documentation](https://docs.djangoproject.com/en/5.0/topics/testing/overview/).

## /carebot/chat/urls.py

 This file contains the url patterns for the `chat` Django app. See [Django documentation](https://docs.djangoproject.com/en/5.0/topics/http/urls/).

## /carebot/chat/views.py

 This file contains the view functions for the Django project. See [Django documentation](https://docs.djangoproject.com/en/5.0/topics/http/views/).

| Function Name | Parameters | Return Value | Other Notes |
| ------------- | ---------- | ------------ | ----------- |
| storeUserLocation()   | HTTP Request | JSON Response  | Loads the JSON data from `sendUserLocation()`, stores the user's latitude and longitude in tuple, appends to array `user_coords`. Often raises Exception due to accessing the HTTP Request multiple times. Catches exception and passes. Needs to be stored within external database for persistance of user location data. Planned to be used within the dashboard heatmap to track where most popular queries are coming from.  |
| chat_view()  |  HTTP Request     |   render() HTML page / JSON Reponse   | **Rate Limiting:** This main Django view takes advantage of the Django `@ratelimting` decorator to limit users to a certain number of queries/minute. Current rate limiting is set at 10 requests/minute and limits by client IP address. For further Django rate limiting documentation, see [Django Ratelimiting](https://django-ratelimit.readthedocs.io/en/stable/). This function attempts to validate the QueryForm (user message to the chatbot). On failure, it returns a generic error page. On success, it continues. It will then pass the 6 most recent Message models and the user input to ChatGPT with a system prompt about its task. If ChatGPT determines there is enough data to make an SQL query, it creates a fake query, the parameters of which are extracted and used in the appropriate pre-written (sanitized) PostgreSQL query. The results are sent back to ChatGPT for a summary and the chatbot message is shown to the user. The new page is finally rendered. If ChatGPT did not determine enough context was present for an SQL query, it will either prompt the user for information or remind the user of its task (thus refusing to go off-topic). All chat messages are logged in Message models. The full details of chat_view() can be found in its comments in `views.py`. |
| limited_chat_view()    |  HTTP Request, Exception      | render() HTML page / JSON Reponse  | Django view specific to catching the Django rate limiting exception in order to trigger the traditional `error.html` page rather than the 403 Forbidden page. Checks if passed exception is an instance of Ratelimited Exception from the ratelimit.exceptions class. Configured by Middleware and triggered by `RATELIMIT_VIEW` within `settings.py`.     |
| log_location_for_heatmap() | city, county, resource_type | None | Logs geolocation data for heatmap visualization on the dashboard. It checks for valid city, county, and resource type before logging. If any of these are "unknown" or missing, it skips logging. |
| load_json_data() | file_path | JSON object | Loads and returns JSON data from a given file path. Used to load static data such as city-to-county mappings and county centroids for geolocation purposes. |
| geocode_city() | city_name | tuple (latitude, longitude) | Returns the latitude and longitude coordinates for a given city by looking up its county in `city-to-county.json` and then finding the county's centroid in `county_centroids.json`. |
| geolocation_data() | HTTP request | JSON Response | Provides geolocation data for all chat requests. It fetches latitude and longitude values from `ChatRequestGeoData` objects and returns them in a JSON response. |
| table_data() | HTTP request | JSON Response | Fetches and aggregates data for the number of chat requests by county, excluding unknown counties. Returns this data in a JSON response for rendering in a table on the dashboard. |
| rate_limited_error_view()    |  HTTP Request      |  render() HTML page / JSON Reponse | Django view specific to catching the Django rate limiting exception. Also has commented out functionality to add any rate limited IP addresses to the list of blacklisted IPs to avoid future malicious users. Renders the standard `error.html` view. |
| error_view() | HTTP request, *args | render() of HTML page | This function renders the generic error page `error.html`. |
| home_view() | HTTP request | render() of HTML page | This function renders `home.html`. |
| dashboard_view() | HTTP request | render() of HTML page | This function renders `dashboard.html`. |
| about_carebot_view() | HTTP request | render() of HTML page | This function renders `about-carebot.html`. |
| about_us_view() | HTTP request | render() of HTML page | This function renders `about-us.html`. |
| deliverables_view() | HTTP request | render() of HTML page | This function renders `deliverables.html`. |
| documentation_view() | HTTP request | render() of HTML page | This function renders `documentation.html`. |
| faq_view() | HTTP request | render() of HTML page | This function renders `faq.html`. |
| handler404() | HTTP request, *args | render() of HTML page | This function renders the generic error page `error.html` with additional 404 information. See [Django documentation](https://docs.djangoproject.com/en/5.0/ref/views/#error-views) for more on error handlers. |
| handler500() | HTTP request, *args | render() of HTML page | This function renders the generic error page `error.html` with additional 500 information. See [Django documentation](https://docs.djangoproject.com/en/5.0/ref/views/#error-views) for more on error handlers. |

# /carebot/chat/migrations/

 The files in this folder are used by Django to process changes to models. Its contents were automatically generated when changes were made, but migrations can also be manually created. The specific contents of this folder are out of scope for this documentation. See [Django documentation](https://docs.djangoproject.com/en/5.0/topics/migrations/).

# /carebot/chat/static/

 This folder contains static assets for the Carebot website. See [Django documentation](https://docs.djangoproject.com/en/5.0/howto/static-files/deployment/).

# /carebot/chat/static/chat/

 This folder contains static assets for the `chat` app of Carebot website. See [Django documentation](https://docs.djangoproject.com/en/5.0/howto/static-files/deployment/).

## /carebot/chat/static/chat/caregiver_connect_icon.svg

 This file is an icon used for a link to the Caregiver Connect website from `chat.html`.

## /carebot/chat/static/chat/chat.js

**Purpose:** Manages the chat interface's interactivity, including sending user messages, displaying system and AI responses, and handling CSRF token for secure AJAX requests within the Carebot application.

| Function Name | Parameters | Return Value | Other Notes |
| ------------- | ---------- | ------------ | ----------- |
| sendUserLocation() | user_latitude, user_longitude | response.json() | Uses AJAX fetch() and HTTP POST methods to send the user coordinates from the frontend to backend. Imported by `chat.html`, called by `getLatLong()`. |

## /carebot/chat/static/chat/home_icon.png

 This file is an icon used for a link to `home.html` from `chat.html`.

## /carebot/chat/static/chat/jake.jpg

 This file is an image of Jake Schaefers (B.S. in Computer Science, 2024). Jake is a member of the first Carebot senior design team.

## /carebot/chat/static/chat/kittson_short.jpg

**Purpose:** This file is an image of Kittson Hamill (B.S. in Computer Science, 2024). Kittson is a member of the first Carebot senior design team.

## /carebot/chat/static/chat/q.jpg

 This file is an image of Quillen Flanigan (B.S. in Computer Science, 2024). Quillen is a member of the first Carebot senior design team.

## /carebot/chat/static/chat/scott.jpg

**Purpose:** This file is an image of Scott Ratchford (B.S. in Computer Science, 2024). Scott is a member of the first Carebot senior design team.

## /carebot/chat/static/chat/styles.css

**Purpose:** This file contains nearly all of the CSS styles used throughout the website.

# /carebot/chat/templates/

 This file contains the Django HTML templates for all the webpages in the project. See [Django documentation](https://docs.djangoproject.com/en/5.0/topics/templates/).

# /carebot/chat/templates/chat/

 This file contains the Django HTML templates for all the webpages in the app. See [Django documentation](https://docs.djangoproject.com/en/5.0/topics/templates/).

## /carebot/chat/templates/chat/about-us.html

 This page lists the Carebot team members and their descriptions.

## /carebot/chat/templates/chat/chat.html

 This is the page for chatting with Carebot, the main portion of the project.

| Function Name | Parameters | Return Value | Other Notes |
| ------------- | ---------- | ------------ | ----------- |
| getUserLocation()    | N/A |  void  | Triggers `navigator.geolocation.GetCurrentPosition()` to ask permission to collect user's location. Calls the `getLatLong()` function and `userError()` as default error function. Initated on window.onload().  |
| showPopUpMsg() | N/A  |  void  | Toggles the location-info popup when the popup button is clicked. Currently commented out and waiting for more nuanced styling. |
| getLatLong() | user_position | void   | Collects the user latitude and longitude, calls the AJAX function `sendUserLocation()` to send user location to backend. Called by `getUserLocation()`  |
| userError()| Exception e |  void  | Error function for `navigator.geolocation.GetCurrentPosition()`. Logs if location is not given by user or if process is not supported by current browser.  |
| hideSuggestedMessages()        | N/A | void   | Changes suggested message button display to none if the chat text box is not empty. Triggered when first message is sent or first suggested message is clicked.  |
| sendSuggestedMessage() | HTML button - suggested message object | void   | Fills the chat text box with the value from the given suggested message button, sends message and calls `hideSuggestedMessages()`  |

## /carebot/chat/templates/chat/dashboard.html

**Purpose:** Displays a dashboard featuring a heatmap visualization of chat request locations across the United States and a table listing the number of requests by county, utilizing Leaflet for mapping and custom scripts for dynamic data presentation.

## /carebot/chat/templates/chat/deliverables.html

**Purpose:** This page contains deliverables for the Spring 2024 Computer Science senior design Carebot team. The included presentation links are to PowerPoint files on the University of Alabama Sharepoint. The links are viewable by anyone with a UA Microsoft account, but they expire before May 2025. The source code is hosted in a private repository under Scott Ratchford's personal GitHub account.

## /carebot/chat/templates/chat/documentation.html

**Purpose:** Serves as the documentation page for the Carebot application, providing links to various resources such as FAQs, installation instructions, technical documentation, and guides on modifying and extending the application, all styled with a consistent look and feel through shared CSS.

## /carebot/chat/templates/chat/error.html

**Purpose:** This is the generic error message page. For security purposes, all types of HTTP/HTTPS errors are directed to this page without exposing the specific error to the user.

## /carebot/chat/templates/chat/faq.html

**Purpose:** This is the frequently asked questions page.

## /carebot/chat/templates/chat/footer.html

**Purpose:** This Django HTML snippet for a footer is included on many pages in the project. It provides a link to the privacy policy.

## /carebot/chat/templates/chat/header.html

**Purpose:** This Django HTML snippet for a header is included on many pages in the project. It provides links to `home.html` and the Caregiver Connect website.

## /carebot/chat/templates/chat/home.html

**Purpose:** This is the homepage for the Carebot website.
